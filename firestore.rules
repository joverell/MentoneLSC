rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check for Admin role from the user's auth token
    function isAdmin() {
      return request.auth.token.roles.hasAny(['Admin']);
    }

    // Helper function to check if the requesting user is the owner of the document
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // Users:
    // - Anyone authenticated can read user profiles.
    // - A user can only create or update their own profile.
    match /users/{userId} {
      allow read: if request.auth != null;
      allow create, update: if isOwner(userId);
      // Deleting users should be handled via the Firebase Admin SDK for safety
      allow delete: if false;
    }

    // News:
    // - Anyone can read news.
    // - Only Admins can write (create, update, delete) news.
    match /news/{newsId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Events:
    // - Anyone can read events.
    // - Authenticated users can create events.
    // - Only the event creator or an Admin can update/delete it.
    match /events/{eventId} {
      allow read: if true;
      allow create: if request.auth != null;
      allow update, delete: if isOwner(resource.data.created_by) || isAdmin();

      // RSVPs Sub-collection:
      // - Any authenticated user can see who is RSVP'd.
      // - A user can only create/update their own RSVP.
      match /rsvps/{userId} {
        allow read: if request.auth != null;
        allow write: if isOwner(userId);
      }
    }

    // Roles and Access Groups:
    // - Authenticated users can read the list of roles/groups.
    // - Only Admins can write them.
    match /roles/{roleId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }
    match /access_groups/{groupId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }

    // Chat Messages:
    // - To read or write, the user must be a member of the group.
    // - We check this by seeing if the group's name exists in the user's auth token.
    match /chats/{groupId}/messages/{messageId} {
        allow read, write: if get(/databases/$(database)/documents/access_groups/$(groupId)).data.name in request.auth.token.groups;
    }

    // Default deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
